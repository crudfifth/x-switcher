(()=>{"use strict";document.addEventListener("DOMContentLoaded",(async()=>{const e=document.getElementById("account-list"),o=(await chrome.storage.local.get(["accounts"])).accounts??[];console.log("[DEBUG] 読み込まれたアカウントリスト:",o);try{const e=await chrome.cookies.getAll({domain:".x.com"}),t=e.find((e=>"twid"===e.name));if(t){const n=decodeURIComponent(t.value).replace(/^u%3D/,"");if(console.log(`[DEBUG] アクティブタブから取得した twid: ${n}`),o.some((e=>e.twid===n)))console.log("[DEBUG] 既に保存済みのアカウントのためスキップ");else{const t=await async function(e){return console.log(`[DEBUG] Popup Script: @username 取得リクエスト送信 (twid=${e})`),new Promise((o=>{chrome.tabs.query({active:!0,currentWindow:!0},(t=>{if(!t[0]?.id)return console.error("[ERROR] Popup Script: タブ ID を取得できませんでした。"),void o(void 0);chrome.tabs.sendMessage(t[0].id,{action:"fetch_username",twid:e},(t=>{if(chrome.runtime.lastError)return console.error("[ERROR] Popup Script: メッセージ送信失敗:",chrome.runtime.lastError),void o(void 0);console.log("[DEBUG] Popup Script: Content Script からのレスポンス:",t),t?.success&&t.username?(console.log(`[DEBUG] Popup Script: 取得成功: ${t.username}`),o(t.username)):(console.warn(`[WARN] Popup Script: @username 取得失敗 (twid=${e})`),o(void 0))}))}))}))}(n),c={name:t??n,twid:n,cookies:e};o.push(c),await chrome.storage.local.set({accounts:o}),console.log("[DEBUG] 新しいアカウントを自動追加:",c)}}else console.warn("[WARN] アクティブタブに `twid` クッキーが見つかりませんでした")}catch(e){console.error("[ERROR] アクティブタブのアカウント取得に失敗:",e)}for(const t of o){const n=document.createElement("button");n.textContent=t.name??t.twid,n.classList.add("account-button"),n.addEventListener("click",(()=>{chrome.runtime.sendMessage({action:"load_session",index:o.indexOf(t)})})),e.appendChild(n)}}))})();